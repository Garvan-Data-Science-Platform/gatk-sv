#!/usr/bin/env Rscript

# Contact: Ryan Collins <rlcollins@g.harvard.edu>

# Helper script to summarize multi-benchmarking results generated by merge_benchmarking_per_sample.R

# Set parameters & read inputs
options(stringsAsFactors=F, scipen=1000)
args <- commandArgs(trailingOnly=TRUE)
dat <- read.table(args[1], header=T, sep="\t", comment.char="")[, -c(1:3)]
dat$length[which(is.na(dat$length) | dat$length < 1)] <- 1
dat$EV <- as.character(sapply(dat$EV, function(estr){
  paste(sort(unlist(strsplit(estr, split=","))), collapse=",")
}))

# Define categories to evaluate
svtypes <- unique(dat$svtype)
AF.bins <- floor(log10(min(dat$AF, na.rm=T))):-1
svlen.bins <- 0:8
EV.bins <- unique(dat$EV)
filters <- setdiff(colnames(dat), c("svtype", "length", "AF", "EV", "ovr"))
filter.combos <- c("none", filters,
                   apply(combn(filters, 2), 2, paste, collapse=";"),
                   apply(combn(filters, 3), 2, paste, collapse=";"))
cats.df <- expand.grid(svtypes, svlen.bins, AF.bins, EV.bins, filter.combos)
colnames(cats.df) <- c("SVTYPE", "SVLEN", "AF", "EV", "COMBO")

# Assign variants to categories
dat$AF.bin <- floor(log10(dat$AF))
dat$AF.bin[which(dat$AF.bin == 0)] <- -1
dat$svlen.bin <- floor(log10(dat$length))
dat$passing.filters <- apply(dat[, filters], 1, function(fvals){
  if(sum(fvals)==0){
    "none"
  }else{
    paste(filters[which(fvals > 0)], collapse=";")
  }
})

# Iterate over all categories and summarize variant count
res <- t(apply(cats.df, 1, function(cat.vals){
  # Get category parameters
  svtype <- as.character(unlist(cat.vals[1]))
  size.bin <- as.numeric(cat.vals[2])
  AF.bin <- as.numeric(cat.vals[3])
  EV.bin <- as.character(cat.vals[4])
  filt.val <- as.character(unlist(cat.vals[5]))

  # Find indexes of variants meeting category criteria
  svtype.match <- which(dat$svtype == svtype)
  svlen.match <- which(dat$svlen.bin == size.bin)
  AF.match <- which(dat$AF.bin == AF.bin)
  EV.match <- which(dat$EV == EV.bin)
  filter.match <- which(dat$passing.filters == filt.val)
  all.matches <- Reduce(intersect, list(svtype.match, svlen.match, AF.match, filter.match))
  n.all.matches <- length(all.matches)
  
  # Calculate fraction of variants in category that are supported by benchmarking
  true.matches <- intersect(all.matches, which(dat$ovr))
  n.true.matches <- length(true.matches)
  frac.true <- if(n.all.matches > 0){n.true.matches/n.all.matches}else{NA}
  
  # Return vector of values
  c(n.all.matches, n.true.matches, frac.true)
}))
colnames(res) <- c("N_all", "N_supported", "pct_supported")

# Join results with categories
out.df <- cbind(cats.df, res)
colnames(out.df)[1] <- paste("#", colnames(out.df)[1], sep="")
write.table(out.df[which(out.df$N_all > 0), ], args[2], sep="\t", 
            col.names=T, row.names=F, quote=F)
